{% load static %}
<!DOCTYPE html>
<html>
<head>
	<meta charset='utf-8'>
	<title>GIMME</title>
</head>
<body class='layout-default'>
	{% include 'common/header.html' %}

	<div id='welcomeBanner'>
		<section class='hero main_hero is-fullheight'>
			<div class='hero-body'>
				<div class='has-text-centered; slider-content animated zoomIn'>
					<div>
						<p class='title is-1 main-text'>Welcome to GIMME-Web, {{request.session.fullName}}</p>
						<p class='subtitle is-4 main-text'>A sophisticated Group Interactions Management Tool</p>
					</div>
				</div>
			</div>
		</section>
	</div>

	<div id='dashboard'>
		<section class='section danger'>
			<div class='panel animated zoomIn'>
				<div class='panel-heading'>
					<div class='columns is-vcentered'>
						<div class='column'>
							<p>Students Setup</p>
						</div>
						<div class='is-pulled-left'>
							<div class='button minimizerButton'></div>
						</div>
					</div>
				</div>
				<div class='panel-block'>
					<div class='column is-offset-1 dash-cell-box'>
						<div class='subtitle is-5 has-tooltip-arrow' style='color:gray;' data-tooltip='These are the students, selected from all available students, to be considered for the next group management iteration.'>Free Students</div>
						<div class='table-container'>
							<div class='table' style='margin:2em;' id='freeUsersTable_professor_dash'></div>
						</div>
					</div>
					<div class='column is-offset-1 dash-cell-box'>
						<div class='subtitle is-4 has-tooltip-arrow' style='color:gray;' data-tooltip='These are the students, selected from all available students, to be considered for the next group management iteration.'>Selected Students</div>
						<div class='table-container column is-full'>
							<div class='table' style='margin:2em;' id='selectedUsersTable_professor_dash'></div>
						</div>
					</div>
				</div>
				<div class='panel-block'>
					<div class='column is-offset-5'>
						<div class='button' type='submit' id='addSpecificPlayer_professor_dash'>Add specific player</div>
					</div>
					<div class='column is-offset-1'>
						<div class='button' type='submit' id='addAllUsers_professor_dash'>Select all</div>
					</div>
					<div class='column is-offset-1'>
						<div class='button' type='submit' id='clearAllUsers_professor_dash'>Deselect all</div>
					</div>
				</div>

			
			</div>
		</section>

		<section class='section'>
			<div class='panel animated zoomIn'>
				<div class='panel-heading'>
					<div class='columns is-vcentered'>
						<div class='column'>
							<p>Tasks Setup</p>
						</div>
						<div class='is-pulled-left'>
							<div class='button minimizerButton'></div>
						</div>
					</div>
				</div>
				<div class='panel-block'>
					<div class='column is-offset-1 dash-cell-box'>
						<div class='subtitle is-5' style='color:gray;' >Free Tasks</div>
						<div class='table-container'>
							<div class='table' style='margin:2em;' id='freeTasksTable_professor_dash'>
							</div>
						</div>
					</div>
					<div class='column is-offset-1 dash-cell-box'>
						<div class='subtitle is-4 has-tooltip-arrow' style='color:gray;' data-tooltip='These are the tasks, selected from all available tasks, to be considered for the next group management iteration.'>Selected Tasks</div>
						<div class='table-container column is-full'>
							<div class='table' style='margin:2em;' id='selectedTasksTable_professor_dash'></div>
						</div>
					</div>
				</div>
				<div class='panel-block'>
					<div class='column is-offset-5'></div>
					<div class='column is-offset-1'>
						<div class='button' type='submit' id='addAllTasks_professor_dash'>Select all</div>
					</div>
					<div class='column is-offset-1'>
						<div class='button' type='submit' id='clearAllTasks_professor_dash'>Deselect all</div>
					</div>
				</div>
			</div>
		</section>



		<section class='section'>
			<div class='panel animated zoomIn'>
				<div class='panel-heading'>
					<div class='columns is-vcentered'>
						<div class='column'>
							<p>Adaptation Setup</p>
						</div>
						<!-- <div class='is-pulled-left'>
							<button class='button has-tooltip' id='toggleAdditionalConfigs_professor_dash' data-tooltip="Toggles additional algorithm selectors.">
								<i class="fa fa-bar-chart" aria-hidden="true"></i>
							</button>
						</div>
						<div class='is-pulled-left'>
							<p> </p>
						</div> -->
						<div class='is-pulled-left'>
							<div class='button minimizerButton'></div>
						</div>
					</div>
				</div>
				

				<div class='panel-block' style='display: block;'>
					<div class='columns is-multiline is-mobile'>
						<div class='column is-full'>
							<p>Groups</p>
						</div>

						<div class='column is-5 columns is-multiline is-mobile'>
							<div class='column is-half'>
								<label id='mgsInput_professor_dash' class='control-label' for='quantity' min='2'>Min Group Size</label>  
								<div class='control'>
									<input id='minNumberOfPlayersPerGroupId_professor_dash' class='input' type='number' min='2' max='100' placeholder='2'>
								</div>
							</div>
							<div class='column is-half'>
								<label class='control-label' for='quantity'>Max Group Size</label>  
								<div class='control'>
									<input id='maxNumberOfPlayersPerGroupId_professor_dash' class='input' type='number' min='3' max='100' placeholder='4'>
								</div>
							</div>
						</div>
						<div class='column is-2 has-text-centered'>
							<p>OR</p>
						</div>

						<div class='column is-5'>
							<label class='control-label' for='quantity'>Preferred Group Size</label>  
							<div class='control'>
								<input id='preferredNumberOfPlayersPerGroupId_professor_dash' class='input' type='number' min='2' max='100' placeholder='4'>
							</div>
						</div>
					</div>
				</div>


				<div class='panel-block' style='display: block;'>
					<div class='columns is-multiline is-mobile has-tooltip-arrow' data-tooltip="Sets the amount of stored past states, for when taking a decision about a student's group. This will only take effect whenever player states are updated.">
						<div class='column is-full'>
							<p>Students</p>
						</div>
						<div class='column is-half is-centered'>
							<label class='field control-label' for='textinput'>Students Past Models Window</label>  
							<div class='field control'>
								<input id='playerWindowId_professor_dash' class='input' type='number' min='1' max='100' placeholder='10'>
							</div>
						</div>
					</div>
				</div>

				<div class='panel-block' style='display: block;'>
					<div class='columns is-multiline is-mobile  has-tooltip-arrow' data-tooltip='This feature is optional, and still does not function as it should.'>
						<div class='column is-full'>
							<p>Bootstrap</p>
						</div>
						
						<div class='column is-half'>
							<label class='checkbox'>
							  <input id='precomputeBootstrapId_professor_dash' type='checkbox'>
							  	Pre-Compute Bootstrap
							</label>
						</div>

						<div class='column is-half'>
							<label class='field control-label' for='textinput'>Number of Bootstrap Iterations</label>  
							<div class='field control'>
								<input id='numBootstrapIterationsId_professor_dash' class='input' type='number' min='20' max='100' placeholder='20'>
							</div>
						</div>
						
					</div>
				</div>

			</div>
		</section>


		<section class='section'>
			<div class='panel animated zoomIn'>
				<div class='panel-heading'>
					<div class='columns is-vcentered'>
						<div class='column'>
							<p>Additional Adaptation Parameters</p>
						</div>
						<div class='is-pulled-left'>
							<p> </p>
						</div>
						<div class='is-pulled-left'>
							<button class='button minimizerButton' id='additionalAdaptMinimizerButton_professor_dash'></button>
						</div>
					</div>
				</div>
		
				<!-- starts hidden -->
				<div class='panel-block' id='additionalAlgorithmsSection_1_professor_dash' style='display: block;'>
					<div class='columns is-multiline is-mobile'>
						<div class='column is-full'>
							<p>Algorithms</p>
						</div>
					</div>

					<div class='columns is-multiline is-mobile'>
						<div class='column is-half'>
							<span>Grouping Alg.</span>
						</div>
						<div class='column is-half'>
							<span>Regression Alg.</span>
						</div>
					</div>
					<div class='columns is-multiline is-mobile'>
						<div class='column is-half'>
							<div class='dropdown'>
								<div class='dropdown-trigger'>
									<button class='button' aria-haspopup='true' aria-controls='dropdown-menu3'>
										<span id='selectedGenAlgId_professor_dash'>
											Grouping Alg.
										</span>
										<span class='icon is-small' >
											<i class='fas fa-angle-down' aria-hidden='true'></i>
										</span>
									</button>
								</div>
								<div class='dropdown-menu' id='dropdown-menu3_professor_dash' role='menu' style="height:35em; overflow-y:scroll">
									<div class='dropdown-content'>
										<a class='dropdown-item is-active'>
											Random
										</a>
										<a class='dropdown-item' data-tooltip='See GIMME-API for details'>
											StochasticHillclimber
											<div class='form-group'>
												<label class='column is-4 control-label' for='textinput'>Num Generated Configurations</label>  
												<div class='control'>
													<input id='numberOfConfigChoicesId_professor_dash' class='input' type='number' min='1' max='1000' placeholder='100'>
												</div>
											</div>
										</a>
										<a class='dropdown-item' data-tooltip='See GIMME-API for details'>
											SimulatedAnnealing
											<div class='form-group'>
												<label class='column is-4 control-label' for='textinput'>Num Generated Configurations</label>  
												<div class='control'>
													<input id='numberOfConfigChoicesId_professor_dash' class='input' type='number' min='1' max='1000' placeholder='100'>
												</div>

												<label class='column is-4 control-label' for='textinput'>Temperature Decay</label>  
												<div class='control'>
													<input id='temperatureDecay_professor_dash' class='input' type='number' min='0' max='1' step="0.01" placeholder='0.5'>
												</div>
											</div>
										</a>
										<a class='dropdown-item' data-tooltip='See GIMME-API for details'>
											Evolutionary
											<div class='form-group'>
												<label class='column is-4 control-label' for='textinput'>Num Generated Configurations</label>  
												<div class='control'>
													<input id='numberOfConfigChoicesId_professor_dash' class='input' type='number' min='1' max='1000' placeholder='100'>
												</div>

												<label class='column is-4 control-label' for='textinput'>Fitness Weights</label>  
												<div class='control'>
													<input id='temperatureDecay_professor_dash' class='input' type='number' min='0' max='1' step="0.01" placeholder='0.5'>
												</div>
												
												<label class='column is-4 control-label' for='textinput'>Mutation Prob</label>  
												<div class='control'>
													<input id='temperatureDecay_professor_dash' class='input' type='number' min='0' max='1' step="0.01" placeholder='0.2'>
												</div>

												<label class='column is-4 control-label' for='textinput'>Num Mutations</label>  
												<div class='control'>
													<input id='temperatureDecay_professor_dash' class='input' type='number' min='0' max='100' step="1" placeholder='4'>
												</div>

												<label class='column is-4 control-label' for='textinput'>Num Fit Survivors (Elitism)</label>  
												<div class='control'>
													<input id='temperatureDecay_professor_dash' class='input' type='number' min='0' max='100' step="1" placeholder='20'>
												</div>
											</div>
										</a>
									</div>
								</div>
							</div>
						</div>



						<div class='column is-half'>
							<div class='dropdown'>
								<div class='dropdown-trigger'>
									<button class='button' aria-haspopup='true' aria-controls='dropdown-menu4'>
										<span id='selectedRegAlgId_professor_dash' >Regression Alg.</span>
										<span class='icon is-small'>
											<i class='fas fa-angle-down' aria-hidden='true'></i>
										</span>
									</button>
								</div>
								<div class='dropdown-menu' id='dropdown-menu3_professor_dash' role='menu'>
									<div class='dropdown-content'>
										<a class='dropdown-item is-active'>
											KNN
											<div class='form-group'>
												<label class='column is-4 control-label' for='textinput'>Num NNs</label>  
												<div class='control'>
													<input  id='numNNsId_professor_dash' class='input' type='number' min='1' max='100' placeholder='5'>
												</div>
											</div>
										</a>
										<a class='dropdown-item'>
											Neural Networks
										</a>
										<a class='dropdown-item'>
											Reinf. Learn.
										</a>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class='panel-block' id='additionalAlgorithmsSection_2_professor_dash' style='display: block;'>
					<div class='columns is-multiline is-mobile'>
						<div class='column is-full'>
							<p>Quality Weights</p>
						</div>

						<div class='column is-half'>
							<label class='control-label' for='quantity'>Ability</label>  
							<div class='control'>
								<input id='qualityWeightsAbId_professor_dash' class='input' type='number' step='0.01' min='0' max='1' placeholder='0.50'>
							</div>
						</div>

						<div class='column is-half'>
							<label class='control-label' for='quantity'>Engagement</label>  
							<div class='control'>
								<input id='qualityWeightsEngId_professor_dash' class='input' type='number' step='0.01' min='0' max='1' placeholder='0.50'>
							</div>
						</div>
					</div>
				</div>

				</div>
			</div>
		</section>


		<section class='section'>
			<div class='panel animated zoomIn'>
				<div class='panel-heading'>
					<div class='columns is-vcentered'>
						<div class='column'>
							<p>Current Adaptation State</p>
						</div>
						<div class='is-pulled-left'>
							<div class='button minimizerButton'></div>
						</div>
					</div>
				</div>
				



				<div class='panel-block'>
					<div class='colums'>
						<p>Group Organization</p>
						

						<div class='columns is-multiline'>
							<div class='column is-one-third has-text-centered has-tooltip-top has-tooltip-arrow'  data-tooltip='Rebuilds the plot, without computing a new adaptation state.'>
								<button class='button is-large' type='submit' id='rebuildPlot_professor_dash'>Rebuild Plots</button>
							</div>
							<div class='column is-one-third has-text-centered has-tooltip-top has-tooltip-arrow' data-tooltip='Loads the parameterization above computes a new adaptation state, iff the configuration changed.' >
								<a>
									<button class='button is-large' type='submit' id='loadAndStartAdaptation_professor_dash' >Load Setup and Compute New Adaptation</button>
								</a>
							</div>
							<div class='column is-one-third has-text-centered  has-tooltip-top has-tooltip-arrow'  data-tooltip='Forces an adaptation call, even when no parameterization changes occur.'>
								<a>
									<button class='button is-large' type='submit' id='forceStartAdaptation_professor_dash'>Force Start Adaptation</button>
								</a>
							</div>
						</div>



						<div id='adaptationError_professor_dash' class='section hero is-danger is-centered has-text-centered'>
							<label class='label subtitle is-4 is-white'>Adaptation Error! Tip: verify if enough players are selected. 
							Maintaining old state...</label>
						</div>
						<div id='adaptationIssues_professor_dash' class='section hero is-warning is-centered has-text-centered'>
							<label class='label subtitle is-4 is-white'>Adaptation Issues Found: </label>
							<label id='adaptationIssuesText_professor_dash'></label>
						</div>
						
						<div class='column is-centered' style='width:100%' id='groupsPlot_professor_dash'></div>

					</div>
				</div>

				<div class='panel-block' style='display: block;'>
					<p>Overall Preferences Distribution</p>
					<div class='columns is-vcentered'>
						<div class='column is-one-third'></div>
						<div class='column is-one-third is-centered' id='professor_interactionsProfilePlot'></div>
						<div class='column is-one-third'></div>
					</div>
				</div>

				<div class='panel-block' style='display: block;'>
					<p>Average Class Learning State</p>
					<div class='columns is-vcentered'>
						<div class='column is-one-third'></div>
						<div class='column is-one-third' id='professor_learningStatePlot'></div>
						<div class='column is-one-third'></div>
					</div>
				</div>
			</div>
		</section>
		{% csrf_token %}


	</div>
	{% include 'common/footer.html' %}
</body>
<script
src='https://code.jquery.com/jquery-3.2.1.min.js'
integrity='sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4='
crossorigin='anonymous'></script>
<script src="https://kit.fontawesome.com/cdbfc7205f.js" crossorigin="anonymous"></script>
<script src='https://d3js.org/d3.v5.js' crossorigin='anonymous'></script>
<script src='https://unpkg.com/d3-force-attract@latest' crossorigin='anonymous'></script>
<!-- <script src='{% static 'js/color.js' %}' crossorigin='anonymous'></script> -->
<script src='{% static 'js/plots.js' %}'></script>

<script>

	$(document).ready(function(){
		
		// CSRF protection setup 
		// (from: 
		// https://docs.djangoproject.com/en/dev/ref/csrf/
		// and https://stackoverflow.com/questions/54835849/django-how-to-send-csrf-token-with-ajax
		// )
		csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
		function csrfSafeMethod(method) {
    		// these HTTP methods do not require CSRF protection
		    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
		}
		$.ajaxSetup({
		    beforeSend: function(xhr, settings) {
		        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
		            xhr.setRequestHeader("X-CSRFToken", csrftoken);
		        }
		    }
		});




		$("#adaptationError_professor_dash").hide();
		$("#adaptationIssues_professor_dash").hide();
		$("#adaptationIssuesText_professor_dash").html('');

		var currServerState = {};
		var currAdaptationConfig = {
							'selectedGenAlgId': '', 
							'selectedRegAlgId': '',

							'numberOfConfigChoices': '',
							'numNNs': '',
							'minNumberOfPlayersPerGroup': '',
							'maxNumberOfPlayersPerGroup': '',
							'preferredNumberOfPlayersPerGroup': '',
							'qualityWeightsAb': '',
							'qualityWeightsEng': '',
							'playerWindow': '',
							'numBootstrapIterations': '',
							'precomputeBootstrap': ''
						};




		// special button effects
		$('#qualityWeightsAb_professor_dash').change(function(){
			$('#qualityWeightsEng_professor_dash').val(1.0 - $(this).val())
		});
		$('#qualityWeightsEng_professor_dash').change(function(){
			$('#qualityWeightsAb_professor_dash').val(1.0 - $(this).val())
		});



		var objChanged = function(obj1, obj2){
			return !(JSON.stringify(obj1) === JSON.stringify(obj2));
		};
		var canComputeAdaptation = function(newServerState){
			newServerState.studentsStates = currServerState.studentsStates
			return objChanged(currServerState, newServerState);
		}



		var generateDashTableFromArray = function(canAdd, idArray, nameArray, tagClass, moveButtonIconClass, moveElementUrl, moveElementArg, addElementURL, addElementArg, deleteElementUrl, deleteElementArg, editElementUrl, editElementArg){
		    var table = $('<div>');
		    for(var i=0; i < idArray.length+1; i++){
		        
		        var tag = undefined;
		        if(!canAdd && i == idArray.length){
		            return table;
		        }
		        if(i<idArray.length){
		        	tag = $("<span class='context-menu' style='margin:0.1em; z-index:1000;'>").text(nameArray[i]);
		        
		        	if(deleteElementUrl!=""){
			            var deleteButton = $("<div class='button is-rounded is-small has-tooltip-arrow' style='color:white; background-color:transparent; margin:0.5em;' data-tooltip='Delete This Task'>");
			            deleteButton.append('<form method=\'GET\' action=\''+deleteElementUrl+'\'>{% csrf_token %}<input type=\'hidden\' name=\''+deleteElementArg+'\' value=\''+idArray[i]+'\'></input><button type=\'submit\' style=\'border: none; background-color:transparent; color:white\' class=\'button pointer\'><i class=\'fas fa-trash pointer\'></i></button></form>');
			            tag.append(deleteButton);
		            }

		        	if(editElementUrl!=""){
			            var editButton = $("<div class='button is-rounded is-small has-tooltip-arrow' style='color:white; background-color:transparent; margin:0.5em;' data-tooltip='Manually Edit State'>");
			            editButton.append('<form method=\'GET\' action=\''+editElementUrl+'\'><input type=\'hidden\' name=\''+editElementArg+'\' value=\''+idArray[i]+'\'></input><button type=\'submit\' style=\'border: none; background-color: transparent; color:white\' class=\'button pointer\'><i class=\'fas fa-edit pointer\'></i></button></form>');
			            tag.append(editButton);
					}

		        	if(moveElementUrl!=""){
			            var moveButton = $("<div class='button is-rounded is-small pointer' style='color:white; background-color:transparent; margin:0.5em;'>");
			            moveButton.append("<i class='fas "+moveButtonIconClass+" pointer'></i>");
			            moveButton.click(function() {
			                var data = {};
			                data[moveElementArg] = $($(this)[0].parentElement).attr("elemID");
			                $.ajax({
			                    url: moveElementUrl,
			                    type: 'POST',
			                    data: data            
			                });
			            })
			            tag.append(moveButton);
					}

		        }else{
		        	if(addElementURL!=""){
		        		var addButton = $("<div class='button is-rounded is-small pointer has-tooltip-arrow' style='color:white; background-color:transparent; margin:0.5em;' data-tooltip='Add New Task'>");
			            addButton.append('<form method="POST" action=\''+addElementURL+'\'>{% csrf_token %}<input type=\'hidden\' name=\''+addElementArg+'\' value=\''+idArray[i]+'\'></input><button type=\'submit\' style=\'border: none; background-color: transparent; color:white\' class=\'button pointer\'><i class=\'fas fa-plus-circle\'></i></button></form>');
		        	
		        		tag = $("<span class='context-menu' style='margin:0.1em; z-index:1000;'>").text(nameArray[i]);
			            tag.append(addButton);
		        	}
		        }

		        if(tag != undefined){
			        tag.attr('elemID', idArray[i]);
			        tag.addClass('tag');
			        tag.addClass(tagClass);
			        tag.addClass('is-medium');
			        tag.addClass('is-rounded');
			        table.append(tag);
			        console.log('here')
			        tag.show(135);
			    }
		    }
		    return table;
		};




		var fetchServerData = function(){
			$.ajax(
			{
				url: '/fetchServerState/',
						dataType: 'json',
						success: 
						function (newServerState) {	
							
							if(!canComputeAdaptation(newServerState)){
								return;
							}

							readyForNewActivity = newServerState.readyForNewActivity;
							if(readyForNewActivity==true){
								$('#forceStartAdaptation_professor_dash').removeClass("is-loading");
								$('#loadAndStartAdaptation_professor_dash').removeClass('is-loading');
								$('#rebuildPlot_professor_dash').removeClass("is-loading");
							}else{
								$('#rebuildPlot_professor_dash').addClass("is-loading");
								$('#forceStartAdaptation_professor_dash').addClass("is-loading");
								$('#loadAndStartAdaptation_professor_dash').addClass("is-loading");
							}

							var currSelectedUsers = newServerState.currSelectedUsers;
							var currFreeUsers = newServerState.currFreeUsers;
							var fuTable = generateDashTableFromArray(
									true, currFreeUsers, currFreeUsers, 'is-info', 'fa-arrow-circle-right', 
									'{% url 'addSelectedUser' %}', 'username',
									'', 'username',
									'','usernameToDelete',
									'{% url 'manuallyManageStudent' %}','usernameToUpdate'
								);
							var suTable = generateDashTableFromArray(
									false, currSelectedUsers, currSelectedUsers, 'is-info', 'fa-arrow-circle-left', 
									'{% url 'removeSelectedUser' %}', 'username',
									'', 'username',
									'','usernameToDelete',
									'{% url 'manuallyManageStudent' %}','usernameToUpdate'
								);
							$('#freeUsersTable_professor_dash').empty();
							$('#freeUsersTable_professor_dash').append(fuTable);

							$('#selectedUsersTable_professor_dash').empty();
							$('#selectedUsersTable_professor_dash').append(suTable);

							var currFreeTasks = unformattedStringToObj(newServerState.currFreeTasks);
							var currSelectedTasks = unformattedStringToObj(newServerState.currSelectedTasks);


							var currFreeTaskIds = [];
							var currSelectedTaskIds = [];

							for (i=0; i< currFreeTasks.length; i++){
								currFreeTaskIds[i] = currFreeTasks[i].taskId;
							}
							for (i=0; i< currSelectedTasks.length; i++){
								currSelectedTaskIds[i] = currSelectedTasks[i].taskId;
							}

							ftTable = generateDashTableFromArray(
								true, currFreeTaskIds, currFreeTaskIds, 'is-danger', 'fa-arrow-circle-right', 
								'{% url 'addSelectedTask' %}', 'taskId',
								'{% url 'taskRegistration' %}', 'taskId',
								'{% url 'taskDeletion' %}','taskIdToDelete',
								'{% url 'taskUpdate' %}','taskIdToUpdate'
							);

							stTable = generateDashTableFromArray(
								false, currSelectedTaskIds, currSelectedTaskIds, 'is-danger', 'fa-arrow-circle-left', 
								'{% url 'removeSelectedTask' %}', 'taskId',
								'{% url 'taskRegistration' %}', 'taskId',
								'{% url 'taskDeletion' %}','taskIdToDelete',
								'{% url 'taskUpdate' %}','taskIdToUpdate'
							);

							$('#freeTasksTable_professor_dash').empty();
							$('#freeTasksTable_professor_dash').append(ftTable);

							$('#selectedTasksTable_professor_dash').empty();
							$('#selectedTasksTable_professor_dash').append(stTable);


							currServerState = newServerState;

							// var studentsStates = {}
							// for(var i=0; i<currSelectedUsers; i++){
							// 	currUserId = currSelectedUsers[i];
							// 	studentsStates[currUserId] = fetchUserStateCallBack(currUserId)
							// }
							
							
							

							$.ajax({
								type: 'POST',
								url: '/fetchStudentStates/',
								success: 
								function(studentsStates)
								{
									$('#groupsPlot_professor_dash').empty();
									currServerState.studentsStates = JSON.parse(studentsStates);
									buildPlots(currServerState);
								}
							});


						}

					}
				);
		};

		fetchServerData();
		setInterval(fetchServerData, 500);


		var buildPlots = function(currServerState){
			buildGroupsPlot('groupsPlot_professor_dash', currServerState.currAdaptationState, currServerState.studentsStates);
			studentsStates = Object.values(currServerState.studentsStates);


			$('#professor_interactionsProfilePlot').empty()
			$('#professor_learningStatePlot').empty()
			var interactionDatapoints = [];
			var avgChars = [0,0];
			for(var i=0; i<studentsStates.length; i++){
				var currState = JSON.parse(studentsStates[i]);
				// console.log(currState)
				interactionDatapoints[i] = { "Full Name": currState.fullName,"focus": currState.preferencesEst.dimensions.Focus*6-3, "challenge": currState.preferencesEst.dimensions.Challenge*6-3 , "timestamp": 1 }
				
				avgChars[0] += currState.characteristics.ability/studentsStates.length;
				avgChars[1] += currState.characteristics.engagement/studentsStates.length;
			}
			buildScatterInteractionPlot('professor_interactionsProfilePlot', interactionDatapoints);
			buildStatePlot('professor_learningStatePlot', 
				[
					{ "name": "Ability" , "value": 0.3/*avgChars[0]*/ },
					{ "name": "Engagement" , "value": 0.6/*avgChars[1]*/ }
				]
			);
		}

		var startAdaptation = function(){
			$.ajax(
				{
					url: '/startAdaptation/',
					dataType: 'json',
					complete:
					function(newServerState){
						// $('#loadAndStartAdaptation_professor_dash').removeClass("is-loading");
						// $('#forceStartAdaptation_professor_dash').removeClass("is-loading");

						$('#groupsPlot_professor_dash').empty();
						if(newServerState.responseText.localeCompare("error")==0){
							$('#adaptationError_professor_dash').show(500);
							setTimeout(function(){ $('#adaptationError_professor_dash').hide(500); }, 5000);
							currServerState = "error";
							return;
						}

						$("#adaptationError_professor_dash").hide();
						currServerState = newServerState;
					}
				}
			);
		}


		var loadAndStartAdaptation = function(){
			newAdaptationConfig = {
							'selectedGenAlgId': $('#selectedGenAlgId_professor_dash').text(), 
							'selectedRegAlgId': $('#selectedRegAlgId_professor_dash').text(),

							'temperatureDecay': $('#temperatureDecay_professor_dash').val(),

							'numberOfConfigChoices': $('#numberOfConfigChoicesId_professor_dash').val(),
							'numNNs': $('#numNNsId_professor_dash').val(),
							'minNumberOfPlayersPerGroup': $('#minNumberOfPlayersPerGroupId_professor_dash').val(),
							'maxNumberOfPlayersPerGroup': $('#maxNumberOfPlayersPerGroupId_professor_dash').val(),
							'preferredNumberOfPlayersPerGroup': $('#preferredNumberOfPlayersPerGroupId_professor_dash').val(),
							'qualityWeightsAb': $('#qualityWeightsAbId_professor_dash').val(),
							'qualityWeightsEng': $('#qualityWeightsEngId_professor_dash').val(),
							'playerWindow': $('#playerWindowId_professor_dash').val(),

							'isBootstrapped': $('#precomputeBootstrapId_professor_dash').prop("checked"),
							'numBootstrapIterations': $('#numBootstrapIterationsId_professor_dash').val()
						};
			currAdaptationConfig = newAdaptationConfig;
			$.ajax(
				{
					url: '/configAdaptation/',
					type: 'POST',
					dataType: 'json',
					data: newAdaptationConfig,
					complete: 
					function () {
						startAdaptation();
					}
				}
			);
		}



		// this tab starts hidden
		var additionalTab = $('#additionalAdaptMinimizerButton_professor_dash');
		$('#additionalAlgorithmsSection_1_professor_dash').hide(0);
		$('#additionalAlgorithmsSection_2_professor_dash').hide(0);
		additionalTab.empty().append("<i class=\"fa fa-window-maximize\"></i>");


		$('#loadAndStartAdaptation_professor_dash').click(function(){
			$('#loadAndStartAdaptation_professor_dash').addClass("is-loading");
			loadAndStartAdaptation();
		})
		$('#forceStartAdaptation_professor_dash').click(function(){
			$('#forceStartAdaptation_professor_dash').addClass("is-loading");
			startAdaptation();
		})
		$('#addAllUsers_professor_dash').click(function(){
			$.ajax(
			{
				type: 'POST',
				url: '/addAllUsersSelected/'
			}
			);
		})
		$('#clearAllUsers_professor_dash').click(function(){
			$.ajax(
			{

				type: 'POST',
				url: '/removeAllUsersSelected/'
			}
			);
		})
		$('#addAllTasks_professor_dash').click(function(){
			$.ajax(
			{

				type: 'POST',
				url: '/addAllTasksSelected/'
			}
			);
		})
		$('#clearAllTasks_professor_dash').click(function(){
			$.ajax(
			{
				type: 'POST',
				url: '/removeAllTasksSelected/'
			}
			);
		})
		$('#addSpecificPlayer_professor_dash').click(function(){
			startAdaptation();
		}).hide()

		$('#rebuildPlot_professor_dash').click(function(){
			$('#groupsPlot_professor_dash').empty();
			if(currServerState.currAdaptationState != undefined && currServerState.currAdaptationState.groups != undefined){
				buildGroupsPlot('groupsPlot_professor_dash', currServerState.currAdaptationState, currServerState.studentsStates);
			}
		})
	});
	


</script>
</html>